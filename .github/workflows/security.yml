name: ğŸ”’ Security Scan

on:
  schedule:
    # æ¯å‘¨ä¸€ä¸Šåˆ 9:00 (UTC) è¿è¡Œå®‰å…¨æ‰«æ
    - cron: '0 9 * * 1'
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ğŸ” ä¾èµ–æ¼æ´æ‰«æ
  dependency-scan:
    name: ğŸ” Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ” NPM Audit
      run: |
        echo "ğŸ” è¿è¡Œ NPM å®‰å…¨å®¡è®¡..."
        npm audit --audit-level moderate --json > npm-audit.json || true
        
    - name: ğŸ“Š NPM Audit Report
      uses: oke-py/npm-audit-action@v2
      with:
        audit_level: moderate
        github_token: ${{ secrets.GITHUB_TOKEN }}
        issue_assignees: DLshujin
        issue_labels: security,dependencies
        
    - name: ğŸ”’ Snyk Security Scan
      uses: snyk/actions/node@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=medium --json > snyk-report.json
        
    - name: ğŸ“¤ Upload Snyk Report
      uses: github/codeql-action/upload-sarif@v2
      if: hashFiles('snyk-report.json') != ''
      with:
        sarif_file: snyk-report.json

  # ğŸ” ä»£ç å®‰å…¨æ‰«æ
  code-scan:
    name: ğŸ” Code Security Analysis
    runs-on: ubuntu-latest
    
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: javascript
        queries: security-extended,security-and-quality
        
    - name: ğŸ—ï¸ Autobuild
      uses: github/codeql-action/autobuild@v2
      
    - name: ğŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:javascript"

  # ğŸ›¡ï¸ å¯†é’¥æ³„éœ²æ£€æŸ¥
  secret-scan:
    name: ğŸ›¡ï¸ Secret Leakage Detection
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ›¡ï¸ TruffleHog Secrets Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  # ğŸ” License åˆè§„æ£€æŸ¥
  license-scan:
    name: ğŸ” License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ” License Check
      run: |
        npx license-checker --summary --onlyAllow 'MIT;ISC;Apache-2.0;BSD-2-Clause;BSD-3-Clause;Apache-2.0 WITH LLVM-exception' > license-report.txt || true
        
    - name: ğŸ“¤ Upload License Report
      uses: actions/upload-artifact@v3
      with:
        name: license-report
        path: license-report.txt

  # ğŸŒ Web å®‰å…¨æ‰«æ
  web-security-scan:
    name: ğŸŒ Web Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build application
      run: npm run build
      
    - name: ğŸŒ Start development server
      run: |
        npm run preview &
        echo $! > server.pid
        sleep 30
        
    - name: ğŸ” OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.7.0
      with:
        target: 'http://localhost:4173'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
        
    - name: ğŸ›‘ Stop development server
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid)
          rm server.pid
        fi

  # ğŸ“‹ å®‰å…¨æŠ¥å‘Šæ±‡æ€»
  security-report:
    name: ğŸ“‹ Security Report Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-scan, secret-scan, license-scan]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download artifacts
      uses: actions/download-artifact@v3
      with:
        path: security-reports/
        
    - name: ğŸ“‹ Generate Security Summary
      run: |
        echo "# ğŸ”’ å®‰å…¨æ‰«ææŠ¥å‘Š" > security-summary.md
        echo "" >> security-summary.md
        echo "**æ‰«ææ—¶é—´:** $(date)" >> security-summary.md
        echo "**åˆ†æ”¯:** ${{ github.ref_name }}" >> security-summary.md
        echo "**æäº¤:** ${{ github.sha }}" >> security-summary.md
        echo "" >> security-summary.md
        
        echo "## ğŸ“Š æ‰«æç»“æœ" >> security-summary.md
        echo "| æ‰«æç±»å‹ | çŠ¶æ€ | è¯¦æƒ… |" >> security-summary.md
        echo "|---------|------|------|" >> security-summary.md
        echo "| ä¾èµ–æ¼æ´æ‰«æ | ${{ needs.dependency-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | æ£€æŸ¥ç¬¬ä¸‰æ–¹ä¾èµ–çš„å·²çŸ¥æ¼æ´ |" >> security-summary.md
        echo "| ä»£ç å®‰å…¨åˆ†æ | ${{ needs.code-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | é™æ€ä»£ç å®‰å…¨åˆ†æ |" >> security-summary.md
        echo "| å¯†é’¥æ³„éœ²æ£€æŸ¥ | ${{ needs.secret-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | æ£€æŸ¥ä»£ç ä¸­çš„æ•æ„Ÿä¿¡æ¯æ³„éœ² |" >> security-summary.md
        echo "| è®¸å¯è¯åˆè§„æ£€æŸ¥ | ${{ needs.license-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | æ£€æŸ¥ä¾èµ–è®¸å¯è¯åˆè§„æ€§ |" >> security-summary.md
        
        echo "" >> security-summary.md
        echo "## ğŸ“‹ å»ºè®®æªæ–½" >> security-summary.md
        echo "- å®šæœŸæ›´æ–°ä¾èµ–åŒ…åˆ°æœ€æ–°ç‰ˆæœ¬" >> security-summary.md
        echo "- å…³æ³¨å®‰å…¨æ¼æ´å…¬å‘Š" >> security-summary.md
        echo "- éµå¾ªå®‰å…¨ç¼–ç è§„èŒƒ" >> security-summary.md
        echo "- å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡" >> security-summary.md
        
    - name: ğŸ“¤ Upload Security Summary
      uses: actions/upload-artifact@v3
      with:
        name: security-summary
        path: security-summary.md
        
    - name: ğŸ’¬ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('security-summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  # ğŸ“§ å®‰å…¨é€šçŸ¥
  security-notification:
    name: ğŸ“§ Security Notification
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-scan, secret-scan]
    if: failure()
    
    steps:
    - name: ğŸ“§ Send security alert
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸš¨ å®‰å…¨æ‰«æå‘ç°é—®é¢˜ - æ•™åŠ¡ç®¡ç†ç³»ç»Ÿ"
        to: adilei.shujin@gmail.com
        from: Security Alert <security@github.com>
        html_body: |
          <h2>ğŸš¨ å®‰å…¨æ‰«æè­¦æŠ¥</h2>
          <p><strong>é¡¹ç›®:</strong> æ•™åŠ¡ç®¡ç†ç³»ç»Ÿ</p>
          <p><strong>åˆ†æ”¯:</strong> ${{ github.ref_name }}</p>
          <p><strong>æ‰«ææ—¶é—´:</strong> ${{ github.run_started_at }}</p>
          <p><strong>å·¥ä½œæµ:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">æŸ¥çœ‹è¯¦æƒ…</a></p>
          
          <h3>ğŸ“‹ æ‰«æç»“æœ:</h3>
          <ul>
            <li>ä¾èµ–æ¼æ´æ‰«æ: ${{ needs.dependency-scan.result }}</li>
            <li>ä»£ç å®‰å…¨åˆ†æ: ${{ needs.code-scan.result }}</li>
            <li>å¯†é’¥æ³„éœ²æ£€æŸ¥: ${{ needs.secret-scan.result }}</li>
          </ul>
          
          <p><strong>âš ï¸ è¯·åŠæ—¶æŸ¥çœ‹å¹¶å¤„ç†å‘ç°çš„å®‰å…¨é—®é¢˜ï¼</strong></p>
          
          <hr>
          <p>æ­¤é‚®ä»¶ç”± GitHub Actions å®‰å…¨æ‰«æè‡ªåŠ¨å‘é€</p>